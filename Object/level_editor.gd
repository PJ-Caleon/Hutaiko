extends Node2D

const in_edit_mode = false
var level_name = "Any Last Words?"

var fk_fall_time: float = 0.92
var fk_output_arr = [[]]

var level_info = {
	"Any Last Words?" ={
		"fk_times":"
		
		[[0.15725620269775, 1.04256232261658, 2.00249441146851, 3.03712018013001, 4.01839025497437, 4.99968250274658, 6.0022903251648, 7.03689344406128, 7.90086181640625, 9.07412727355957, 10.0127440261841, 10.9940138626099, 12.0286398696899, 12.9245806503296, 16.2097512054443, 16.5724030303955, 16.9777088928223, 17.9056454467773, 18.3749657440186, 18.9295922088623, 19.2389107513428, 19.9215412902832, 20.3695240783691, 20.860158996582, 21.8627892303467, 22.0867577362061, 22.2894326019287, 22.5134011077881, 26.1932202148437, 26.3745346832275, 26.5665303039551, 26.7691841888428, 26.9611798095703, 27.1211567687988, 27.2918148803711, 27.4624710845947, 27.665147857666, 27.8144665527344, 28.0491162109375, 28.241111831665, 28.4437638092041, 28.6144219207764, 28.8704090881348, 29.4250336456299, 29.6490250396729, 29.8410206604004, 30.4276638793945, 30.5983219909668, 30.8009758758545, 31.0249653625488, 31.4942646789551, 31.9742413330078, 32.4542179870605, 32.6248760986328, 32.8275280761719, 33.0301800537109, 33.5101605224609, 33.9794789123535, 34.6834240722656, 34.9074154663086, 35.0780735778809, 35.238073425293, 35.4513836669922, 35.6220417785645, 35.8033772277832, 35.9846936035156, 36.1873455810547, 36.3793431091309, 36.5606594848633, 36.7313137817383, 36.9553051757812, 37.4566212463379, 37.659273223877, 37.8085957336426, 38.0112477111816, 38.4805661010742, 38.6512242126465, 38.8325405883789, 39.0671864318848, 39.5685025024414, 40.0378247070312, 40.2084790039062, 40.3897953796387, 40.5604534912109, 40.76310546875, 40.9977551269531, 41.4884129333496, 42.0110417175293, 43.4189587402344, 44.3362599182129, 44.5495701599121, 44.7735615539551, 44.9975491333008, 45.2108631896973, 45.4455319213867, 45.6695233154297, 45.8721752929687, 46.117483215332, 46.3628102111816, 46.5761242675781, 46.8107929992676, 47.0454426574707, 47.2800923156738, 47.4934254455566, 47.7494107055664, 47.9520626831055, 48.2293873596191, 48.4533558654785, 48.7093411254883, 48.9226742553711, 49.1573239135742, 49.3493214416504, 49.5519734191895, 50.0746022033691, 50.2559414672852, 50.4585934448242, 50.6505909729004, 50.8745823669434, 51.8025151062012, 52.0371647644043, 52.271837310791, 52.4744892883301, 52.698480682373, 52.9011326599121, 53.1357823181152, 53.8290692138672, 54.0317478942871, 54.2343998718262, 54.4583912658691, 54.6397038269043, 54.9063473510742, 55.1303387451172, 55.9302960205078, 56.1649647521973, 56.3889332580566, 56.5809307861328, 56.8049221801758, 57.0182553100586, 57.2315655517578, 57.412878112793, 57.6475506591797, 57.8395252990723, 58.063512878418, 58.7888203430176, 58.9381390380859, 59.0874615478516, 60.0687542724609, 60.2607479858398, 60.4847164916992, 60.6767102050781, 60.9860325622559, 61.4660092163086, 61.6793194580078, 61.8606587219238, 62.0633106994629, 62.4899540710449, 62.692606048584, 62.948595123291, 63.4285717773437, 64.0792065429687, 64.2712002563477, 64.5165081787109, 64.7404995727539, 64.9538327026367, 65.5511303710937, 66.0204296875, 66.2230816650391, 66.4257336425781, 66.6070767211914, 66.7990475463867, 66.9910412597656, 67.151044921875, 67.3536968994141, 67.8229962158203, 68.0896588134766, 68.2923107910156, 68.5269604492187, 68.7082958984375, 68.9002743530273, 69.4229260253906, 69.6042385864258, 69.7855587768555, 69.9988919067383, 70.4361935424805, 70.6388455200195, 70.8308392333984, 71.0868283081055, 71.5241528320312, 72.078779296875, 72.2707730102539, 72.4840832519531, 72.6867352294922, 72.9107266235352, 73.4546948242187, 74.0093441772461, 74.2119961547852, 74.4146481323242, 74.6173001098633, 74.85197265625, 75.0546246337891, 75.5985928344727, 76.2385464477539, 76.441198425293, 76.6438809204102, 76.8785229492187, 77.4473248291016, 77.9451275634766, 79.129072265625, 80.0143566894531, 80.8463040161133, 81.8275967407227, 82.9475308227539]]

",
		"music": load("res://Music/AnyLastWords.wav")
	}
}

func _ready():

	$MusicPlayer.stream = level_info.get(level_name).get("music")
	$MusicPlayer.play()

	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)

		if fk_times_arr is Array and fk_times_arr.size() > 0:
			for key in fk_times_arr:
				for delay in key:
					spawn_falling_key("hit_btn", delay)

func KeyListenerPress(button_name: String, array_num: int):
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position()-fk_fall_time)

func spawn_falling_key(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	print(fk_output_arr)
